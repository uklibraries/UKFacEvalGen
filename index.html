<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>University of Kentucky Libraries Evaluation Form Generator</title>
<script>
// Copyright University of Kentucky Libraries, 2020
// Authors: Kathryn Lybarger & Eric Weig
// License: https://creativecommons.org/licenses/by-sa/4.0/

var evaldata;

function evalUpdate() {

    // set flag for console output
    // set to 1 in order to view output in console
    var isConsole = 1;

    // set variables for faculty info
    var personalName = document.getElementsByName("personalname")[0].value;
    var superVisor = document.getElementsByName("supervisor")[0].value;
    var jobTitle = document.getElementsByName("jobtitle")[0].value;
    var divDpt = document.getElementsByName("division_department")[0].value;
    var otherEvals = document.getElementsByName("other_evaluators")[0].value;
    var rank = document.getElementsByName("rank")[0].value;
    var revYear = document.getElementsByName("review_year")[0].value;
    var nxtPromo = document.getElementsByName("next_promo")[0].value;

    // set variables for faculty DOE
    var doe_001 = document.getElementsByName("doe_inst_ref_serve")[0].value;
    var doe_002 = document.getElementsByName("doe_inst_lib_inst")[0].value;
    var doe_003 = document.getElementsByName("doe_inst_tech_serve")[0].value;
    var doe_004 = document.getElementsByName("doe_inst_info_tech")[0].value;
    var doe_005 = document.getElementsByName("doe_inst_coll_mangr")[0].value;
    var doe_006 = document.getElementsByName("doe_inst_other_primary")[0].value;
    var doe_007 = document.getElementsByName("doe_res_int_fund")[0].value;
    var doe_008 = document.getElementsByName("doe_res_ext_fund")[0].value;
    var doe_009 = document.getElementsByName("doe_res_gifts")[0].value;
    var doe_010 = document.getElementsByName("doe_res_no_fund")[0].value;
    var doe_011 = document.getElementsByName("doe_serv_pub")[0].value;
    var doe_012 = document.getElementsByName("doe_serv_prof")[0].value;
    var doe_013 = document.getElementsByName("doe_serv_coll_dept")[0].value;
    var doe_014 = document.getElementsByName("doe_serv_univ")[0].value;
    var doe_015 = document.getElementsByName("doe_serv_patient")[0].value;
    var doe_016 = document.getElementsByName("doe_serv_qaa")[0].value;
    var doe_017 = document.getElementsByName("doe_serv_clinic_serv")[0].value;
    var doe_018 = document.getElementsByName("doe_serv_clinic_contract")[0].value;
    var doe_019 = document.getElementsByName("doe_serv_hosp")[0].value;
    var doe_020 = document.getElementsByName("doe_admin_chair")[0].value;
    var doe_021 = document.getElementsByName("doe_admin_other_1")[0].value;
    var doe_022 = document.getElementsByName("doe_admin_univ_lv")[0].value;
    var doe_023 = document.getElementsByName("doe_admin_cdd")[0].value;
    var doe_024 = document.getElementsByName("doe_admin_md")[0].value;
    var doe_025 = document.getElementsByName("doe_admin_other_pos")[0].value;
    var doe_026 = document.getElementsByName("doe_admin_other_2")[0].value;
    var doe_027 = document.getElementsByName("doe_admin_gift")[0].value;
    var doe_028 = document.getElementsByName("doe_profdev_sabb")[0].value;
    var doe_029 = document.getElementsByName("doe_profdev_leave")[0].value;
    var doe_030 = document.getElementsByName("doe_profdev_dev")[0].value;

    // add up all the DOE numbers
    var doe_total = +doe_001 + +doe_002 + +doe_003 + +doe_004 + +doe_005 + +doe_006 + +doe_007 + +doe_008 + +doe_009 + +doe_010 + +doe_011 + +doe_012 + +doe_013 + +doe_014 + +doe_015 + +doe_016 + +doe_017 + +doe_018 + +doe_019 + +doe_020 + +doe_021 + +doe_022 + +doe_023 + +doe_024 + +doe_025 + +doe_026 + +doe_027 + +doe_028 + +doe_029 + +doe_030;

    // display current total for DOE numbers
    document.getElementById("doe_total").innerHTML = doe_total;

    // build data file for Word Document generation
    evaldata = {
    ratings: [
        'Unsatisfactory',
        'Improvement Expected',
        'Provisional',
        'Solid',
        'Distinguished'
    ],
    person: {
        name: personalName,
        job_title: jobTitle,
        division: divDpt,
        supervisor: superVisor,
        other_evaluators: otherEvals,
        rank: rank,
        review_year: revYear,
        next_pt_date: nxtPromo,
    },
    DOE: [
         {
               name: 'Instruction',
               subcats: [
                    {
                         name: 'Reference Services',
                         percent: doe_001,
                    },
                    {
                         name: 'Library Instruction',
                         percent: doe_002,
                    },
                    {
                         name: 'Technical Services',
                         percent: doe_003,
                    },
                    {
                         name: 'Information Technology',
                         percent: doe_004,
                    },
                    {
                         name: 'Collection Management',
                         percent: doe_005,
                    },
                    {
                         name: 'Other Primary Activities',
                         percent: doe_006,
                    },
                 ]
         },
         {
               name: 'Research',
               subcats: [
                    {
                         name: 'Internally funded research',
                         percent: doe_007,
                    },
                    {
                         name: 'Externally funded research',
                         percent: doe_008,
                    },
                    {
                         name: 'Gifts',
                         percent: doe_009,
                    },
                    {
                         name: 'Non-funded research',
                         percent: doe_010,
                    },
		]
	 },	
         {
               name: 'Service',
               subcats: [
                    {
                         name: 'Service to Public',
                         percent: doe_011,
                    },
                    {
                         name: 'Service to Professions',
                         percent: doe_012,
                    },
                    {
                         name: 'Service to Institution College and Department',
                         percent: doe_013,
                    },
                    {
                         name: 'Service to Institution University Level',
                         percent: doe_014,
                    },
                    {
                         name: 'Direct Patient Care and Clinical Service',
                         percent: doe_015,
                    },
                    {
                         name: 'Quality Assurance Activities',
                         percent: doe_016,
                    },
                    {
                         name: 'Other Clinical Services',
                         percent: doe_017,
                    },
                    {
                         name: 'Clinical Contract Work or Other Cash Income',
                         percent: doe_018,
                    },
                    {
                         name: 'Hospital Physician Service for all Patients',
                         percent: doe_019,
                    },
                  ]
          },
          {
               name: 'Administration',
               subcats: [
                    {
                         name: 'College and Department DGS DUS',
                         percent: doe_020,
                    },
                    {
                         name: 'College and Department Other',
                         percent: doe_021,
                    },
                    {
                         name: 'University Level',
                         percent: doe_022,
                    },
                    {
                         name: 'UK Health Care Enterprise Clinical Division Director',
                         percent: doe_023,
                    },
                    {
                         name: 'UK Health Care Enterprise Medical Director',
                         percent: doe_024,
                    },
                    {
                         name: 'UK Health Care Enterprise Other Position',
                         percent: doe_025,
                    },
                    {
                         name: 'UK Health Care Enterprise Other administrative activities',
                         percent: doe_026,
                    },
                    {
                         name: 'UK Health Care Enterprise Fund Raising',
                         percent: doe_027,
                    },
		  ]
	 },
         {
               name: 'Professional Development',
               subcats: [
                    {
                         name: 'Sabbatical Leave',
                         percent: doe_028,
                    },
                    {
                         name: 'Other Approved Leave',
                         percent: doe_029,
                    },
                    {
                         name: 'Other Development',
                         percent: doe_030,
                    },
                  ]
          },
         ]
     }

     if(isConsole) { 
      // echo changes to console for testing 
      console.log('evaldata', evaldata);
     }

}
</script>

<link href="https://fonts.googleapis.com/css?family=Muli&display=swap" rel="stylesheet">
<style>
body {
	margin: 0px;
	font-family: 'Muli', sans-serif;
	font-size: 16px;
}
.divTable{
	display: table;
	width: 100%;
}
.divTableRow {
	display: table-row;
}
.divTableHeading {
	background-color: #EEE;
	display: table-header-group;
}
.divTableCell, .divTableHead {
	border: 0px solid #999999;
	display: table-cell;
	padding: 3px 10px;
}
.divTableHeading {
	background-color: #EEE;
	display: table-header-group;
	font-weight: bold;
}
.divTableFoot {
	background-color: #EEE;
	display: table-footer-group;
	font-weight: bold;
}
.divTableBody {
	display: table-row-group;
}
#generator_form, #form_help {
        padding: 25px;
        background: #a5acaf;
}
#submit_button {
        position: sticky;
        top: 0;	
}
#form_button {
	display: block;
	top: 0px;
	right: 0px;
	background: #1897d4;
	padding: 22px;
}
button {
       display: block;
       text-align: center;
       margin-left: auto;
       margin-right: auto;
}
ul {
       list-style-type:none;
}
li {
       padding: 5px;
}
h2 {
       padding-left: 25px;
}
label:after {
       content: ' : ';
}
label {
       font-weight: bold;
}
#generator_form {
       padding-bottom: 10px;
       border-bottom: 1px solid #1B365D;
       background: #a5acaf;
}
#doe_form {
	padding: 25px;
}
#doe_total {
       float: right;
       padding-right: 10px;
       font-weight: bold;
       font-size: 20px;
       position: sticky;
       top: 0;
}
#doe_total:before {
       content: ' % total: ';
}
#form_help {
       background: #C8C8C7;
       margin-bottom: 0px;
       margin-top: 0px;
}
#form_help > label {
	color:#1897d4
}
.footer-list {
       list-style-type:none;
       color: white;
       text-align:center;
}
.footer-list-item {
       display: inline-block;
       padding-left: 5px;
       padding-right: 5px;
}
.footer-list-item a, a:visited, a:hover {
       color: white;
       text-decoration: none;
}
.footer-text-center {
       text-align:center;
}
#footer {
       background:#1B365D;
       position:absolute;
       width:100%;
       padding-top: 25px;
       padding-bottom: 25px;
}
#app_title {
       float: right;
       color: white;
       padding-right: 10px;
       font-size: 25px;
}
#uk_branding {
       width:100%;
       height:65px;
       background:#1B365D;
       text-align:center;
       margin-left:auto;
       margin-right:auto;
}
#uk_branding > a > img {
       float: left;
       padding-top: 5px;
       padding-bottom: 5px;
       padding-left: 10px;
       width: 180px;
}
</style>
</head>
<body>
<div id="content">
<!-- header start -->

<div id="uk_branding">
	<a href="https://libraries.uky.edu/"><img src="https://libraries.uky.edu/images/libraries-white.png" alt="University of Kentucky Libraries"></a>
	<span id="app_title">UK Libraries Evaluation Form Generator</span>
</div>

<!-- header end -->

	<!-- help section start -->

	<p id="form_help">
		<label>HELP</label>  Complete desired form fields before generating your form.  Click the button to download your generated evaluation form.
	</p>

	<!-- help section end -->

		<!-- form generator buttom start -->
		
		<div id="submit_button">
			<div id="form_button">
				<button type="button" id="generate">Generate Evaluation Form</button>
			</div>
		</div>

		<!-- form generator buttom end -->
	
			<!-- generator entry faculty info form start -->
	
			<div id="generator_form">
				<div class="divTable">
					<div class="divTableBody">
						<div class="divTableRow">
							<div class="divTableCell">
								<label>Name</label>
							</div>
								<div class="divTableCell">
									<input type="text" name="personalname" onkeyup="evalUpdate()" onchange="evalUpdate()"/>
								</div>
							<div class="divTableCell">
								<label>Supervisor</label>
							</div>
							<div class="divTableCell">
								<input type="text" name="supervisor" onkeyup="evalUpdate()" onchange="evalUpdate()"/>
							</div>
						</div>
						<div class="divTableRow">
							<div class="divTableCell">
								<label>Job Title</label>
							</div>
							<div class="divTableCell">
								<input type="text" name="jobtitle" onkeyup="evalUpdate()" onchange="evalUpdate()"/>
							</div>
							<div class="divTableCell">
								<label>Other Evaluators</label>
							</div>
							<div class="divTableCell">
								<input type="text" name="other_evaluators" onkeyup="evalUpdate()" onchange="evalUpdate()"/>
							</div>
						</div>
						<div class="divTableRow">
							<div class="divTableCell">
								<label>Division / Department</label>
							</div>
							<div class="divTableCell">
								<input type="text" name="division_department" onkeyup="evalUpdate()" onchange="evalUpdate()"/>
							</div>
							<div class="divTableCell">
								<label>Rank</label>
							</div>
							<div class="divTableCell">
								<input type="text" name="rank" onkeyup="evalUpdate()" onchange="evalUpdate()"/>
							</div>
						</div>
						<div class="divTableRow">
							<div class="divTableCell">
								<label>Next Promotion / Tenure date</label>
							</div>
							<div class="divTableCell">
								<input type="text" name="next_promo" onkeyup="evalUpdate()" onchange="evalUpdate()"/>
							</div>
							<div class="divTableCell">
								<label>Review Year</label>
							</div>
							<div class="divTableCell">
								<input type="text" name="review_year" onkeyup="evalUpdate()" onchange="evalUpdate()"/>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- generator entry faculty info form end -->

			<!-- distribution of effort start -->

			<div id="doe_form">
				<div id="doe_total"></div>
				<h4>Section  I.   Instruction</h4>
				<ul>
					<li>f. Libraries - Primary Assignment</li>
						<li><ul>
							<li>Reference/Information Service <input type="number" name="doe_inst_ref_serve" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Library Instruction <input type="number" name="doe_inst_lib_inst" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Technical Services <input type="number" name="doe_inst_tech_serve" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Information Technology <input type="number" name="doe_inst_info_tech" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Collection Management <input type="number" name="doe_inst_coll_mangr" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Administration (report in Sect IV)</li>
							<li>Other Primary Activities <input type="number" name="doe_inst_other_primary" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
						</ul></li>
				</ul>
				<h4>Section  II.  Research</h4>
				<ul>
					<li>a. Internally funded research <input type="number" name="doe_res_int_fund" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
					<li>b. Externally funded research <input type="number" name="doe_res_ext_fund" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
					<li>c. Gifts <input type="number" name="doe_res_gifts" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
					<li>d. Non-funded research (general research efforts) <input type="number" name="doe_res_no_fund" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
				</ul>
				<h4>Section  III. Service</h4>
				<ul>	
				<li>a. Service to Public <input type="number" name="doe_serv_pub" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li> 
					<li>b. Service to Professions <input type="number" name="doe_serv_prof" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
					<li>c. Service to Institution</li>
						<li>
						<ul>
							<li>College and Department <input type="number" name="doe_serv_coll_dept" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>University Level <input type="number" name="doe_serv_univ" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							</ul></li>
					<li>d. Patient Care Unrelated to Instruction</li>
						<li><ul>
							<li>Direct Patient Care and Clinical Service <input type="number" name="doe_serv_patient" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Quality Assurance Activities <input type="number" name="doe_serv_qaa" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Other Clinical Services <input type="number" name="doe_serv_clinic_serv" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Clinical Contract Work or Other Cash Income <input type="number" name="doe_serv_clinic_contract" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Hospital Physician Service for all Patients <input type="number" name="doe_serv_hosp" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							</ul></li>
				</ul>
				<h4>Section  IV. Administration</h4>
				<ul>
					<li>a. College and Department</li>
						<li><ul>
 							<li>Chair Vice Chair/equivalent Academic Division Director/Chief Other position (e.g., DGS, DUS) <input type="number" name="doe_admin_chair" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Other administrative activities <input type="number" name="doe_admin_other_1" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							</ul></li>
					<li>b. University Level <input type="number" name="doe_admin_univ_lv" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
					<li>c. UK Health Care Enterprise</li>
						<li><ul>
							<li>Clinical Division Director/Chief <input type="number" name="doe_admin_cdd" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Medical Director <input type="number" name="doe_admin_md" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Other Position <input type="number" name="doe_admin_other_pos" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							<li>Other administrative activities <input type="number" name="doe_admin_other_2" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
							</ul></li>
					<li>d. Fund Raising (Private Gift Solicitation) <input type="number" name="doe_admin_gift" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
				</ul>
				<h4>Section  V.  Professional Development</h4>
				<ul>
					<li>a. Sabbatical Leave <input type="number" name="doe_profdev_sabb" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
					<li>b. Other Approved Leave (e.g. TDL, educational, scholarly) <input type="number" name="doe_profdev_leave" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
					<li>c. Other Development (e.g. conferences, networking) <input type="number" name="doe_profdev_dev" onkeyup="evalUpdate()" onchange="evalUpdate()"/></li>
				</ul>
			</div>

			<!-- distribution of effort end -->

	<!-- generator entry form end -->

<!-- footer -->

    <div id="footer">
        <div>
            <div class="footer-text-center">
                <a href="http://uky.edu" title="University of Kentucky">
                    <img src="https://libraries.uky.edu/images/uklogo.png" height="60" alt="University of Kentucky">
                </a>
                <a href="http://libguides.uky.edu/fedgov" title="This library is a Congressionally designated Regional Depository for U.S. Government Publications. Public access to the federal government publications collection is guaranteed by public law.">
                    <img src="https://libraries.uky.edu/images/fdlp.png" alt="Federal Depository Library">
                </a>
            </div>
        </div>
        <div class="row">
            <div>
                <ul class="footer-list">
                    <li class="footer-list-item">© <a href="http://uky.edu" title="University of Kentucky">University of Kentucky</a></li>
                    <li class="footer-list-item">An Equal Opportunity University</li>
                    <li class="footer-list-item"><a href="http://www.uky.edu/accreditation/" title="Accreditation">Accreditation</a></li>
                    <li class="footer-list-item"><a href="https://directory.uky.edu/" title="Directory">Directory</a></li>
                </ul>
            </div>
        </div>
    </div>

</div>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.2/jszip.js" integrity="sha256-bBikss7mndcF6KmskR4ihPSlxoyGAxuG4Gf/rzolOTg=" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js" integrity="sha256-u/J1Urdrk3nCYFefpoeTMgI5viU1ujCDu2fXXoSJjhg=" crossorigin="anonymous"></script>
<script>

document.getElementById("generate").addEventListener("click",function() {
  const zip = new JSZip();
  fetch( "fppa.docx" )
    .then( response => response.blob() )
    .then( blob => zip.loadAsync(blob) )
    .then( () => zip.folder("word").file("document.xml").async("string") )
    .then( document_xml_content => transmogrify( document_xml_content, evaldata ) )
    .then( new_document_xml_content => zip.folder("word").file("document.xml", new_document_xml_content ) )
    .then( () => zip.generateAsync({type:"blob",mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",compression:"DEFLATE"}) )
    .then( blob => saveAs( blob, "fppa.docx" ) )
});

function fppaTreeEntry( name, indent, percent ) {
  return (`
    <w:p>
      <w:pPr>
        <w:numPr>
          <w:ilvl w:val="${indent}"/>
          <w:numId w:val="6"/>
        </w:numPr>
        <w:rPr>
          <w:color w:val="0000FF"/>
        </w:rPr>
      </w:pPr>
      <w:r>
        <w:rPr>
          <w:color w:val="0000FF"/>
        </w:rPr>
        <w:t>${name}${percent>0?" (" + percent + "%)":""}</w:t>
      </w:r>
    </w:p>
`);
}

function fppaBlocksGrayBar( text ) {
	return (`
	<w:p>
      <w:pPr>
        <w:keepNext/>
        <w:keepLines/>
		<w:pBdr>
          <w:top w:val="nil"/>
          <w:left w:val="nil"/>
          <w:bottom w:val="nil"/>
          <w:right w:val="nil"/>
          <w:between w:val="nil"/>
        </w:pBdr>
        <w:shd w:val="clear" w:color="auto" w:fill="D9D9D9"/>
        <w:spacing w:before="40" w:line="360" w:lineRule="auto"/>
        <w:jc w:val="center"/>
        <w:rPr>
          <w:rFonts w:ascii="Calibri" w:eastAsia="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/>
          <w:b/>
          <w:color w:val="000000"/>
          <w:sz w:val="24"/>
		  <w:szCs w:val="24"/>
        </w:rPr>
      </w:pPr>
      <w:r>
        <w:rPr>
          <w:rFonts w:ascii="Calibri" w:eastAsia="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/>
          <w:b/>
          <w:color w:val="000000"/>
          <w:sz w:val="24"/>
          <w:szCs w:val="24"/>
        </w:rPr>
        <w:t>${text}</w:t>
      </w:r>
    </w:p>
`);
}

function fppaBlocksHeading( text ) {
	return (`
    <w:p>
      <w:r>
        <w:rPr>
          <w:b/>
        </w:rPr>
        <w:t>${text}</w:t>
      </w:r>
    </w:p>
`);
}

function fppaBlocksBlankLineForSelf() {
	return (`
	<w:p>
	  <w:r>
        <w:rPr>
          <w:color w:val="0000FF"/>
        </w:rPr>
		<w:t xml:space="preserve"> </w:t>
      </w:r>
    </w:p>
`);
}

function fppaBlocksBlankLineForSupervisor() {
	return (`
	<w:p>
	  <w:r>
        <w:rPr>
          <w:color w:val="880088"/>
        </w:rPr>
		<w:t xml:space="preserve"> </w:t>
      </w:r>
    </w:p>
`);
}

function fppaBlocksTableCell(text,width,color="0000FF",first=false,last=false) {
//          <w:tcPr>
//            <w:tcW w:w="${width}" w:type="dxa"/>
//          </w:tcPr>
  return (`
        <w:tc>
		  <w:tcPr>
            <w:tcMar>
              ${first?"":'<w:start w:w="250" w:type="dxa"/>'}
              <w:end w:w="40" w:type="dxa"/>
            </w:tcMar>
			<w:vAlign w:val="bottom"/>
		  </w:tcPr>
          <w:p>
            <w:r>
              <w:rPr>
                <w:sz w:val="28"/>
                <w:u w:val="thick"/>
                <w:color w:val="${color}"/>
              </w:rPr>
              <w:t>&#xa0;&#xa0;&#xa0;</w:t>
            </w:r>
		  </w:p>
        </w:tc>
        <w:tc>
		  <w:tcPr>
            <w:tcMar>
              <w:start w:w="40" w:type="dxa"/>
              ${last?"":'<w:end w:w="250" w:type="dxa"/>'}
            </w:tcMar>
			<w:vAlign w:val="bottom"/>
		  </w:tcPr>
          <w:p>
            <w:r>
              <w:rPr>
                <w:sz w:val="18"/>
              </w:rPr>
              <w:t xml:space="preserve">${text}</w:t>
            </w:r>
          </w:p>
        </w:tc>
`);
}

function fppaBlocksTable( levels, widths, color="0000FF" ) {
	return (`
    <w:tbl>
      <w:tblPr>
        <w:tblStyle w:val="a2"/>
        <w:tblW w:w="0" w:type="auto"/>
        <w:tblLook w:val="04A0" w:firstRow="1" w:lastRow="0" w:firstColumn="1" w:lastColumn="0" w:noHBand="0" w:noVBand="1"/>
      </w:tblPr>
      <w:tblGrid>${widths.map( w => `<w:gridCol w:w="${w}"/>`).join("") }</w:tblGrid>
      <w:tr>${levels.map( (lvl,i) => fppaBlocksTableCell( lvl, widths[i], color, i==0, i==levels.length-1 ) ).join("") }</w:tr>
    </w:tbl>
`);
}

function transmogrify( string_content, evaldata ) {
  const widths = [ 2085, 1995, 1815, 1350, 2115 ];

  var fppatree = []
  var fppablocks = [];
  fppatree.push("</w:t></w:r></w:p>");
  fppablocks.push("</w:t></w:r></w:p>");
  for (const cat of evaldata.DOE) {
    if (cat.subcats.some(subcat=>subcat.percent)) {
      fppatree.push(fppaTreeEntry( cat.name, 0, 0 ));
      for (const subcat of cat.subcats) {
        if (subcat.percent) {
          fppatree.push(fppaTreeEntry( subcat.name, 1, subcat.percent ));
          fppablocks.push( fppaBlocksGrayBar( `${subcat.name} (${subcat.percent}%)` ) );
		  fppablocks.push( "<w:p/>" );
          fppablocks.push( fppaBlocksHeading( "Self Rating:" ) );
		  fppablocks.push( "<w:p/>" );
          fppablocks.push( fppaBlocksTable( evaldata.ratings, widths, "0000FF" ) );
		  fppablocks.push( "<w:p/>" );
          fppablocks.push( fppaBlocksHeading( "Description of activities and achievements / justification of rating:" ) );
		  fppablocks.push( fppaBlocksBlankLineForSelf() );
		  fppablocks.push( fppaBlocksBlankLineForSelf() );
          fppablocks.push( fppaBlocksHeading( "Supervisor Rating:" ) );
		  fppablocks.push( "<w:p/>" );
          fppablocks.push( fppaBlocksTable( evaldata.ratings, widths, "880088" ) );
		  fppablocks.push( "<w:p/>" );
          fppablocks.push( fppaBlocksHeading( "Supervisor comments and justification of rating:" ) );
		  fppablocks.push( fppaBlocksBlankLineForSupervisor() );
		  fppablocks.push( fppaBlocksBlankLineForSupervisor() );
          fppablocks.push( fppaBlocksHeading( "Recommended action (if required):" ) );
		  fppablocks.push( fppaBlocksBlankLineForSupervisor() );
		  fppablocks.push( fppaBlocksBlankLineForSupervisor() );
        }
      }
    }
  }
  fppatree.push("<w:p><w:r><w:t>");
  fppablocks.push("<w:p><w:r><w:t>");
  fppatree = fppatree.join("");
  fppablocks = fppablocks.join("");

  return string_content
	.replace(/FPPA_NAME/,evaldata.person.name)
	.replace(/FPPA_SUPE/,evaldata.person.supervisor)
	.replace(/FPPA_JOB/,evaldata.person.job_title)
	.replace(/FPPA_OTHER/,evaldata.person.other_evaluators)
	.replace(/FPPA_DIVDEPT/,evaldata.person.division)
	.replace(/FPPA_RANK/,evaldata.person.rank)
	.replace(/FPPA_PTDATE/,evaldata.person.next_pt_date)
	.replace(/FPPA_REVYEAR/,evaldata.person.review_year)
	.replace(/FPPA_TREE/,fppatree)
	.replace(/FPPA_BLOCKS/,fppablocks)

}

</script>
</body>
</html>
